---
title: "Reproducible documents"
author: "Jessica Preston"
format: html
---

#Seting up R correctly

```{r setup}
library(targets)
library(tidyverse)
tar_config_set(store = here::here("_targets"))
source(here::here("R/functions.R"))
lipidomics <- tar_read(lipidomics)
```

## Making a table

```{r}
tar_read(table_descriptive_stats) |>
  knitr::kable(
    caption = "The mean and SD of metabolites in the lipidomics dataset"
  )
```

## Results:: Distribution plot

```{r}
tar_read(plot_distributions)
```

## Preparing the data for a model

```{r}
lipidomics |>
  count(code, metabolite) |>
  filter(n > 1)
```

Keep the mean value for duplicate values when all other characteristics
match. Writing a function to clean it.

```{r}
#' Clean data to sumarize repeat values
#'
#' @param data , lipidomics df
#'
#' @returns cleaned df

clean <- function(data) {
  data |>
    dplyr::group_by(dplyr::pick(-value)) |>
    dplyr::summarise(value = mean(value), .groups = "keep") |>
    dplyr::ungroup()
}

clean(lipidomics)
```

## Pre-processing data for fitting into a model

```{r}
#' Preprocessing of the data
#' changes metabolites to a class variable and scaling the metabolite groups
#' @param data, lipidomics df
#'
#' @returns cleaned df (lipidomics)

preprocess <- function(data) {
  data |>
    dplyr::mutate(
      class = as.factor(class),
      value = scale(value) # so that it scales cholesterol to be compared to future metabolites
    )
}

preprocess(lipidomics)
```

## Try to make data set only for cholesterol

also run the model on only cholesterol

```{r}
just_cholesterol <- lipidomics |>
  filter(metabolite == "Cholesterol") |>
  preprocess()

glm( # write model for cholesterol vs. condition(class)
  formula = class ~ value,
  data = just_cholesterol,
  family = binomial()
) |>
  broom::tidy(exponentiate = TRUE) |> # model results into a more readable format using the broom::tidy function
  mutate(
    metabolite =
      unique(just_cholesterol$metabolite),
    model = format(class ~ value),
    .before = everything()
  )
```

##Creat a function to fit the model function for selecting data and
model

```{r}
#' Fitting a model function
#'
#' @param data, df (lipidomics)
#' @param model, pre-defined model (x ~  y)
#'
#' @returns table of model results

fit_model <- function(data, model) {
  stats::glm(
    formula = model,
    data = data,
    family = binomial()
  ) |>
    broom::tidy(exponentiate = TRUE) |> # model results into a more readable format using the broom::tidy function
    dplyr::mutate(
      metabolite = unique(data$metabolite),
      model = format(model),
      .before = dplyr::everything()
    )
}

fit_model(just_cholesterol, class ~ value)
```

## Creating the model results for cholesterol only

```{r}
#' Generating model results
#'
#' @param data df, lipidomics
#'
#' @returns model results, a tibble

create_model_results <- function(data) {
  data |>
    dplyr::filter(metabolite == "Cholesterol") |>
    preprocess() |> # calling our previous function
    fit_model(class ~ value) # calling our previous function
}

create_model_results(lipidomics)
```

## Run all metabolite models together at once

```{r}
lipidomics |>
  group_split(metabolite) |>
  map(preprocess) |>
  map(fit_all_models) |>
  purrr::list_rbind()
```

## Appendix

```{r}
tar_read(model_results) |>
  knitr::kable(
    caption = "Lipidomics Model Results"
  )
```
